<!DOCTYPE html>
<html>
<head>
    <title>Site Snapshots Comparison</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
    }
    .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
    }
    .site-list {
        margin-bottom: 30px;
    }
    .site-item {
        cursor: pointer;
        padding: 15px;
        margin: 10px 0;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        background: #fafafa;
        transition: all 0.3s ease;
    }
    .site-item:hover {
        background: #e3f2fd;
        border-color: #2196f3;
        transform: translateY(-2px);
    }
    .site-item.active {
        background: #e8f5e8;
        border-color: #4caf50;
    }
    .site-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .site-url {
        font-weight: bold;
        color: #1565c0;
        font-size: 16px;
    }
    .site-meta {
        color: #666;
        font-size: 14px;
    }
    .snapshots-container {
        display: none;
        margin-top: 20px;
    }
    .snapshots-header {
        background: #333;
        color: white;
        padding: 15px;
        border-radius: 8px 8px 0 0;
        margin-bottom: 0;
    }
    .snapshots-comparison {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 0;
    }
    .snapshot-panel {
        border: 1px solid #ddd;
        border-radius: 0 0 8px 8px;
        background: white;
    }
    .snapshot-header {
        background: #f5f5f5;
        padding: 15px;
        border-bottom: 1px solid #ddd;
        font-weight: bold;
        color: #333;
    }
    .snapshot-content {
        padding: 15px;
        max-height: 800px;
        overflow-y: auto;
    }
    .stats {
        background: #e8f5e8;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
        font-size: 14px;
    }
    .category-section {
        margin: 20px 0;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        overflow: hidden;
        background: white;
    }
    .category-header {
        background: #2196f3;
        color: white;
        padding: 12px;
        font-weight: bold;
        font-size: 14px;
    }
    .staff-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
        margin: 10px 0;
    }
    .staff-table th,
    .staff-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
        vertical-align: top;
    }
    .staff-table th {
        background: #f5f5f5;
        font-weight: bold;
        position: sticky;
        top: 0;
    }
    .staff-table tr:nth-child(even) {
        background: #f9f9f9;
    }
    .staff-table tr:hover {
        background: #f0f8ff;
    }
    .no-data {
        color: #666;
        font-style: italic;
        padding: 20px;
        text-align: center;
    }
    .loading {
        text-align: center;
        padding: 20px;
        color: #666;
    }
    .error {
        background: #ffebee;
        color: #c62828;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
    }
    .comparison-stats {
        background: #fff3e0;
        padding: 15px;
        border-radius: 4px;
        margin: 15px 0;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        text-align: center;
    }
    .stat-item {
        padding: 10px;
        border-radius: 4px;
        font-weight: bold;
    }
    .stat-total { background: #e8f5e8; color: #2e7d32; }
    .stat-added { background: #c8e6c9; color: #1b5e20; }
    .stat-removed { background: #ffcdd2; color: #b71c1c; }
    .back-button {
        background: #666;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin-bottom: 20px;
    }
    .back-button:hover {
        background: #555;
    }
</style>
</head>
<body>
    <div class="container">
        <button class="back-button" onclick="window.location.href='/'">‚Üê Back to Main</button>
        <h1>üìä Site Snapshots Comparison</h1>
        
        <div class="site-list" id="siteList">
            <div class="loading">Loading sites...</div>
        </div>
        
        <div class="snapshots-container" id="snapshotsContainer">
            <h2 class="snapshots-header" id="snapshotsHeader">Snapshots for: <span id="currentSiteName"></span></h2>
            <div class="comparison-stats" id="comparisonStats" style="display: none;">
                <div class="stat-item stat-total">
                    <div>Total Snapshots</div>
                    <div id="totalSnapshots">0</div>
                </div>
                <div class="stat-item stat-added">
                    <div>Latest Staff Count</div>
                    <div id="latestCount">0</div>
                </div>
                <div class="stat-item stat-removed">
                    <div>Previous Staff Count</div>
                    <div id="previousCount">0</div>
                </div>
            </div>
            <div class="snapshots-comparison" id="snapshotsComparison">
                <!-- Snapshots will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let allSites = [];
        let currentSiteId = null;

        // Load all sites when page loads
        document.addEventListener('DOMContentLoaded', fetchAllSites);

        async function fetchAllSites() {
            const siteList = document.getElementById('siteList');
            
            try {
                const response = await fetch('/sites');
                const result = await response.json();
                
                if (result.sites && result.sites.length > 0) {
                    allSites = result.sites;
                    displaySitesList(result.sites);
                } else {
                    siteList.innerHTML = '<div class="no-data">No sites found in database.</div>';
                }
            } catch (error) {
                siteList.innerHTML = `<div class="error">Error loading sites: ${error.message}</div>`;
            }
        }

        function displaySitesList(sites) {
            const siteList = document.getElementById('siteList');
            
            siteList.innerHTML = '<h2>Available Sites</h2>';
            
            sites.forEach(site => {
                const siteDiv = document.createElement('div');
                siteDiv.className = 'site-item';
                siteDiv.innerHTML = `
                    <div class="site-info">
                        <div>
                            <div class="site-url">${site.baseUrl}</div>
                            <div class="site-meta">
                                Directory: ${site.staffDirectory}<br>
                                Last scraped: ${site.lastScrapedAt ? new Date(site.lastScrapedAt).toLocaleString() : 'Never'}
                            </div>
                        </div>
                        <div style="font-size: 24px;">‚Üí</div>
                    </div>
                `;
                siteDiv.onclick = () => loadSiteSnapshots(site._id, site.baseUrl);
                siteList.appendChild(siteDiv);
            });
        }

        async function loadSiteSnapshots(siteId, siteName) {
            currentSiteId = siteId;
            
            // Update UI
            document.querySelectorAll('.site-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            const container = document.getElementById('snapshotsContainer');
            const header = document.getElementById('currentSiteName');
            const comparison = document.getElementById('snapshotsComparison');
            const stats = document.getElementById('comparisonStats');
            
            header.textContent = siteName;
            container.style.display = 'block';
            comparison.innerHTML = '<div class="loading">Loading snapshots...</div>';
            stats.style.display = 'none';
            
            try {
                // Fetch all snapshots for this site
                const response = await fetch(`/site/${siteId}/snapshots`);
                const result = await response.json();
                
                if (result.snapshots && result.snapshots.length > 0) {
                    console.log(result)
                    displaySnapshots(result.snapshots, siteName);
                    updateComparisonStats(result.snapshots);
                } else {
                    comparison.innerHTML = '<div class="no-data">No snapshots found for this site.</div>';
                }
            } catch (error) {
                comparison.innerHTML = `<div class="error">Error loading snapshots: ${error.message}</div>`;
            }
        }

        function displaySnapshots(snapshots, siteName) {
            const comparison = document.getElementById('snapshotsComparison');
            
            // Sort snapshots by date (newest first)
            snapshots.sort((a, b) => new Date(b.snapshotDate) - new Date(a.snapshotDate));
            
            // Show latest two snapshots for comparison, or just the latest if only one exists
            const snapshotsToShow = snapshots.slice(0, 2);
            
            comparison.innerHTML = '';
            
            snapshotsToShow.forEach((snapshot, index) => {
                const isLatest = index === 0;
                const snapshotDiv = document.createElement('div');
                snapshotDiv.className = 'snapshot-panel';
                snapshotDiv.innerHTML = `
                    <div class="snapshot-header">
                        ${isLatest ? 'üÜï LATEST' : 'üìÖ PREVIOUS'} SNAPSHOT
                        <span style="float: right; font-size: 12px; font-weight: normal;">
                            ${new Date(snapshot.snapshotDate).toLocaleString()}
                        </span>
                    </div>
                    <div class="snapshot-content">
                        <div class="stats">
                            <strong>Total Staff:</strong> ${snapshot.totalCount} | 
                            <strong>Categories:</strong> ${snapshot.categories.length} |
                            <strong>Run ID:</strong> ${snapshot.runId}
                        </div>
                        ${displayCategories(snapshot.categories)}
                    </div>
                `;
                comparison.appendChild(snapshotDiv);
            });
            
            // If only one snapshot, show message
            if (snapshotsToShow.length === 1) {
                const messageDiv = document.createElement('div');
                messageDiv.style.gridColumn = '1 / -1';
                messageDiv.innerHTML = '<div class="no-data">Only one snapshot available. Run scraping again to compare changes.</div>';
                comparison.appendChild(messageDiv);
            }
        }

function displayCategories(categories) {
    if (!categories || categories.length === 0) {
        return '<div class="no-data">No categories found</div>';
    }
    
    let html = '';
    categories.forEach(category => {
        
        html += `
            <div class="category-section">
                <div class="category-header">
                    ${category.name} (${category.count} staff)
                </div>
                <div style="padding: 10px;">
                    ${displayStaffTable(category.members || [])}
                </div>
            </div>
        `;
    });
    return html;
}

function displayStaffTable(members) {
    if (!members || members.length === 0) {
        return '<div class="no-data">No staff members in this category</div>';
    }
    
    let html = `
        <table class="staff-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Title</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Profile URL</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    members.forEach(member => {
        // Handle profile URL - make it clickable if available
        const profileUrl = member.profileUrl ? 
            `<a href="${member.profileUrl}" target="_blank" style="font-size: 10px; word-break: break-all;">${member.profileUrl}</a>` : 
            'N/A';
        
        html += `
            <tr>
                <td><strong>${member.name || 'N/A'}</strong></td>
                <td>${member.title || 'N/A'}</td>
                <td>${member.emails && member.emails.length > 0 ? member.emails.join(', ') : 'N/A'}</td>
                <td>${member.phones && member.phones.length > 0 ? member.phones.join(', ') : 'N/A'}</td>
                <td>${profileUrl}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    return html;
}
        function updateComparisonStats(snapshots) {
            const stats = document.getElementById('comparisonStats');
            const totalSnapshots = document.getElementById('totalSnapshots');
            const latestCount = document.getElementById('latestCount');
            const previousCount = document.getElementById('previousCount');
            
            totalSnapshots.textContent = snapshots.length;
            
            if (snapshots.length > 0) {
                latestCount.textContent = snapshots[0].totalCount;
                previousCount.textContent = snapshots.length > 1 ? snapshots[1].totalCount : 'N/A';
                stats.style.display = 'grid';
            }
        }

        // Add keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && currentSiteId) {
                // Clear selection when Escape is pressed
                document.querySelectorAll('.site-item').forEach(item => item.classList.remove('active'));
                document.getElementById('snapshotsContainer').style.display = 'none';
                currentSiteId = null;
            }
        });
    </script>
</body>
</html>