<!DOCTYPE html>
<html>

<head>
  <title>Scraper Control</title>
  <style>
    /* Header Section Styles */
    .header-container {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .nav-link {
      display: inline-block;
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      text-decoration: none;
      font-weight: 600;
      margin-bottom: 15px;
      transition: all 0.3s ease;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .nav-link:hover {
      background-color: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .main-title {
      font-size: 2.5em;
      margin: 10px 0 25px 0;
      font-weight: 700;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .btn-primary {
      background: linear-gradient(45deg, #4CAF50, #45a049);
      color: white;
    }

    .btn-secondary {
      background: linear-gradient(45deg, #2196F3, #1976D2);
      color: white;
    }

    .btn-warning {
      background: linear-gradient(45deg, #ff9800, #f57c00);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(45deg, #f44336, #d32f2f);
      color: white;
    }

    .status-container {
      background-color: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
      font-weight: 500;
      min-height: 20px;
    }

    /* Existing styles remain the same */
    table {
      border-collapse: collapse;
      width: 100%;
      margin: 15px 0;
      font-size: 14px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
      font-weight: bold;
    }

    .site-item {
      cursor: pointer;
      padding: 8px;
      margin: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .site-item:hover {
      background-color: #f0f8ff;
    }

    .failed-item {
      cursor: pointer;
      padding: 8px;
      margin: 4px;
      border: 1px solid #ffcccc;
      border-radius: 4px;
      background-color: #fff5f5;
    }

    .failed-item:hover {
      background-color: #ffe6e6;
    }

    .category-section {
      margin: 20px 0;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
    }

    .category-header {
      background-color: #e8f4fd;
      padding: 10px;
      margin: -15px -15px 15px -15px;
      border-radius: 8px 8px 0 0;
      font-weight: bold;
      font-size: 16px;
    }

    .failed-section {
      margin: 20px 0;
      border: 1px solid #ffcccc;
      border-radius: 8px;
      padding: 15px;
      background-color: #fff5f5;
    }

    .failed-header {
      background-color: #ffebee;
      padding: 10px;
      margin: -15px -15px 15px -15px;
      border-radius: 8px 8px 0 0;
      font-weight: bold;
      font-size: 16px;
      color: #d32f2f;
    }

    .stats {
      background-color: #f9f9f9;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }

    .failed-stats {
      background-color: #ffebee;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }

    .no-data {
      color: #666;
      font-style: italic;
      padding: 10px;
    }

    .failure-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-right: 8px;
    }

    .failure-no-data {
      background-color: #ff9800;
      color: white;
    }

    .failure-fetch {
      background-color: #f44336;
      color: white;
    }

    .failure-parsing {
      background-color: #9c27b0;
      color: white;
    }

    .html-snippet {
      font-family: monospace;
      background-color: #f5f5f5;
      padding: 8px;
      border-radius: 4px;
      font-size: 12px;
      max-height: 100px;
      overflow-y: auto;
      margin: 5px 0;
    }

    .changes-section {
      margin: 20px 0;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      background-color: #fff;
    }

    .changes-header {
      background-color: #e8f5e8;
      padding: 10px;
      margin: -15px -15px 15px -15px;
      border-radius: 8px 8px 0 0;
      font-weight: bold;
      font-size: 16px;
      color: #2e7d32;
    }

    .change-item {
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 12px;
      margin: 10px 0;
      background-color: #f9f9f9;
    }

    .change-meta {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 12px;
      color: #666;
    }

    .change-stats {
      display: flex;
      gap: 15px;
      margin-bottom: 10px;
    }

    .change-stat {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }

    .stat-added {
      background-color: #e8f5e8;
      color: #2e7d32;
    }

    .stat-removed {
      background-color: #ffebee;
      color: #c62828;
    }

    .stat-updated {
      background-color: #fff3e0;
      color: #ef6c00;
    }

    .change-details {
      margin-top: 10px;
    }

    .change-table {
      width: 100%;
      font-size: 12px;
      margin: 5px 0;
    }

    .change-table th {
      background-color: #f5f5f5;
      padding: 4px;
      text-align: left;
    }

    .change-table td {
      padding: 4px;
      border-bottom: 1px solid #eee;
    }

    .diff-highlight {
      background-color: #fff9c4;
      padding: 1px 3px;
      border-radius: 2px;
    }
  </style>
  <style>
    /* Enhanced Container Styles */
.section-container {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    color: #333;
    padding: 20px;
    border-radius: 12px;
    margin: 20px 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.sites-container, .failed-container, .snapshot-container {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    padding: 20px;
    border-radius: 12px;
    margin: 20px 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

/* Enhanced Table Styles */
.table-container {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin: 15px 0;
}

.table-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px;
    font-size: 1.2em;
    font-weight: bold;
}

/* Enhanced Item Styles */
.site-item, .failed-item {
    background: white;
    padding: 15px;
    margin: 10px 0;
    border-radius: 8px;
    border-left: 4px solid #667eea;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    cursor: pointer;
}

.site-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    border-left-color: #4CAF50;
}

.failed-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    border-left-color: #f44336;
}

/* Enhanced Category Sections */
.category-section {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 0;
    margin: 20px 0;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
}

.category-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 20px;
    font-weight: bold;
    font-size: 1.1em;
    margin: 0 !important;
}

/* Enhanced Changes Section */
.changes-section {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 0;
    margin: 20px 0;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
}

.changes-header {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
    padding: 15px 20px;
    font-weight: bold;
    font-size: 1.1em;
    margin: 0 !important;
}

/* Enhanced Change Items */
.change-item {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px;
    margin: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Enhanced Stats */
.stats, .failed-stats {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
    border-left: 4px solid #2196F3;
    font-weight: 500;
}

/* Enhanced Badges */
.failure-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    margin-right: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.failure-no-data { 
    background: linear-gradient(45deg, #ff9800, #f57c00);
    color: white; 
}
.failure-fetch { 
    background: linear-gradient(45deg, #f44336, #d32f2f);
    color: white; 
}
.failure-parsing { 
    background: linear-gradient(45deg, #9c27b0, #7b1fa2);
    color: white; 
}

/* Enhanced HTML Snippet */
.html-snippet {
    font-family: 'Courier New', monospace;
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: #ecf0f1;
    padding: 12px;
    border-radius: 6px;
    font-size: 12px;
    max-height: 120px;
    overflow-y: auto;
    margin: 8px 0;
    border-left: 4px solid #e74c3c;
}
/* Pagination Styles */
.pagination-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin: 20px 0;
    padding: 15px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 8px;
}

.page-btn {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    background: linear-gradient(45deg, #6c757d, #5a6268);
    color: white;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.page-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.page-btn.active {
    background: linear-gradient(45deg, #667eea, #764ba2);
}

.page-info {
    font-weight: bold;
    color: #495057;
    margin: 0 10px;
}
/* Search Styles */
.search-container {
    margin: 20px 0;
}

.search-box {
    display: flex;
    gap: 10px;
    align-items: center;
    max-width: 600px;
    margin: 0 auto;
}

#siteSearch {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.3s ease;
    background: white;
}

#siteSearch:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.search-info {
    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
    padding: 10px 15px;
    border-radius: 6px;
    margin: 10px 0;
    border-left: 4px solid #ffc107;
    font-size: 14px;
}
/* Search Highlight */
.search-highlight {
    background-color: #ffeb3b;
    padding: 2px 4px;
    border-radius: 3px;
    font-weight: bold;
}
/* Failed Directories Styles */
.failed-container {
    background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
    padding: 20px;
    border-radius: 12px;
    margin: 20px 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border: 1px solid #fed7d7;
}

.failed-item {
    background: white;
    padding: 15px;
    margin: 10px 0;
    border-radius: 8px;
    border-left: 4px solid #f56565;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.failed-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    border-left-color: #e53e3e;
}

.failure-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    margin-right: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.failure-no-data { 
    background: linear-gradient(45deg, #ff9800, #f57c00);
    color: white; 
}
.failure-fetch { 
    background: linear-gradient(45deg, #f44336, #d32f2f);
    color: white; 
}
.failure-parsing { 
    background: linear-gradient(45deg, #9c27b0, #7b1fa2);
    color: white; 
}
  </style>
</head>

<body>
<div class="header-container">
    <!-- <a href="snapshots.html" class="nav-link">📸 View Snapshots</a> -->
    <h1 class="main-title">Staff Directory Scraper</h1>
    
    <div class="button-group">
        <button class="btn btn-primary" onclick="triggerScraping()">🚀 Start Scraping Now</button>
        <button class="btn btn-secondary" onclick="fetchSites(1)">📋 Fetch Available Sites</button>
        <button class="btn btn-warning" onclick="fetchFailedDirectories()">⚠️ View Failed Directories</button>
        <button class="btn btn-danger" onclick="clearFailedDirectories()">🗑️ Clear Failed List</button>
    </div>
    
<!-- Update the search container in your header -->
<div class="search-container">
    <div class="search-box">
        <input type="text" id="siteSearch" placeholder="🔍 Search sites by domain or directory..." 
               onkeypress="handleSearchKeypress(event)">
        <button class="btn btn-primary" onclick="performSearch(event)">Search</button>
        <button class="btn btn-secondary" onclick="clearSearch(event)">Clear</button>
    </div>
</div>
    
    <div id="status" class="status-container"></div>
</div>

  <div id="sitesList" style="margin: 20px 0;"></div>
  <div id="failedList" style="margin: 20px 0;"></div>
  <div id="snapshotData" style="margin: 20px 0;"></div>
  <div id="changeHistory" style="margin: 20px 0;"></div>

  <script>
    // Your existing JavaScript remains exactly the same
    async function triggerScraping() {
      const button = document.querySelector('.btn-primary');
      const status = document.getElementById('status');

      button.disabled = true;
      button.textContent = '⏳ Scraping...';
      status.innerHTML = '🔄 Scraping started... This may take a while.';

      try {
        const response = await fetch('/scrape-now', {
          method: 'POST'
        });

        const result = await response.json();
        status.innerHTML = `✅ ${result.message}`;
      } catch (error) {
        status.innerHTML = `❌ Error: ${error.message}`;
      } finally {
        button.disabled = false;
        button.textContent = '🚀 Start Scraping Now';
      }
    }

    let currentPage = 1;
const sitesPerPage = 20;
let currentSearch = '';

function handleSearchKeypress(event) {
    if (event.key === 'Enter') {
        event.preventDefault(); // Prevent form submission
        event.stopPropagation(); // Prevent event bubbling
        performSearch();
    }
}
// Update performSearch function
function performSearch(event) {
    if (event) {
        event.stopPropagation(); // Prevent event bubbling
        event.preventDefault(); // Prevent form submission
    }
    
    const searchInput = document.getElementById('siteSearch');
    currentSearch = searchInput.value.trim();
    currentPage = 1; // Reset to first page when searching
    fetchSites(currentPage, currentSearch);
}
// Update clearSearch function  
function clearSearch(event) {
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    const searchInput = document.getElementById('siteSearch');
    searchInput.value = '';
    currentSearch = '';
    currentPage = 1;
    fetchSites(currentPage, '');
}

// Update handleSearchKeypress
function handleSearchKeypress(event) {
    if (event.key === 'Enter') {
        event.preventDefault(); // Prevent form submission
        event.stopPropagation(); // Prevent event bubbling
        performSearch();
    }
}

async function fetchSites(page = 1, search = '') {
  const status = document.getElementById('status');
  const sitesList = document.getElementById('sitesList');
  const failedList = document.getElementById('failedList');
  
  status.innerHTML = '📡 Fetching sites...';
    sitesList.innerHTML = '';
    failedList.innerHTML = '';
    
    try {
      // Build URL with search parameter
      const url = `/sites?page=${page}&limit=${sitesPerPage}${search ? `&search=${encodeURIComponent(search)}` : ''}`;
      
      console.log({search, page, url})
      const response = await fetch(url);
        const result = await response.json();
        console.log(result)
        if (result.sites && result.sites.length > 0) {
            // Create sites container with header
            const sitesContainer = document.createElement('div');
            sitesContainer.className = 'sites-container';
            
            // Build header based on search
            const headerText = result.search ? 
                `🔍 Search Results for "${result.search}"` : 
                '✅ Available Sites';
            
            sitesContainer.innerHTML = `
                <div class="table-header">
                    ${headerText} (${result.pagination.totalSites} total)
                </div>
                ${result.search ? `
                    <div class="search-info">
                        Found ${result.pagination.totalSites} sites matching "${result.search}"
                        <button class="btn btn-secondary" onclick="clearSearch()" style="margin-left: 10px; padding: 4px 8px; font-size: 12px;">
                            Clear Search
                        </button>
                    </div>
                ` : ''}
                <div class="stats">
                    Showing ${result.sites.length} sites - Page ${result.pagination.currentPage} of ${result.pagination.totalPages}
                </div>
            `;

            // Create sites list
            const sitesWrapper = document.createElement('div');
            result.sites.forEach(site => {
                const siteDiv = document.createElement('div');
                siteDiv.className = 'site-item';
                
                // Highlight search term in results
                const highlightedUrl = result.search ? highlightText(site.baseUrl, result.search) : site.baseUrl;
                const highlightedDir = result.search ? highlightText(site.staffDirectory, result.search) : site.staffDirectory;
                
                siteDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong style="flex: 1;">${highlightedUrl}</strong>
                        <span style="font-size: 12px; color: #666;">
                            Last scraped: ${new Date(site.lastScrapedAt).toLocaleString()}
                        </span>
                    </div>
                    <div style="margin-top: 8px; font-size: 13px; color: #555;">
                        Directory: ${highlightedDir}
                    </div>
                `;
                siteDiv.onclick = () => fetchSiteSnapshot(site._id, site.baseUrl);
                sitesWrapper.appendChild(siteDiv);
            });

            sitesContainer.appendChild(sitesWrapper);
            
            // Add pagination controls
            const paginationDiv = createPaginationControls(result.pagination, result.search);
            sitesContainer.appendChild(paginationDiv);
            
            sitesList.appendChild(sitesContainer);
            
            const statusText = result.search ? 
                `✅ Found ${result.pagination.totalSites} sites matching "${result.search}"` :
                `✅ Found ${result.pagination.totalSites} sites total`;
            status.innerHTML = statusText;
            
            currentPage = page;
            currentSearch = search;
        } else {
            const noResultsHtml = result.search ? 
                `<p>No sites found matching "${result.search}"</p>
                 <button class="btn btn-secondary" onclick="clearSearch()">Show All Sites</button>` :
                '<p>No sites found in database.</p>';
                
            sitesList.innerHTML = `
                <div class="sites-container">
                    <div class="table-header">
                        ${result.search ? '🔍 Search Results' : 'Available Sites'}
                    </div>
                    ${noResultsHtml}
                </div>
            `;
            status.innerHTML = result.search ? 
                `❌ No sites found for "${result.search}"` : 
                'ℹ️ No sites available';
        }
    } catch (error) {
        status.innerHTML = `❌ Error fetching sites: ${error.message}`;
    }
}

// Update pagination function to preserve search
function createPaginationControls(pagination, search = '') {
    const paginationDiv = document.createElement('div');
    paginationDiv.style.cssText = `
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
        padding: 15px;
        background: rgba(255,255,255,0.5);
        border-radius: 8px;
        flex-wrap: wrap;
    `;

    // Previous button
    if (pagination.hasPrev) {
        const prevBtn = document.createElement('button');
        prevBtn.className = 'btn btn-secondary';
        prevBtn.innerHTML = '⬅ Previous';
        prevBtn.onclick = () => fetchSites(pagination.currentPage - 1, search);
        paginationDiv.appendChild(prevBtn);
    }

    // Page info
    const pageInfo = document.createElement('span');
    pageInfo.style.cssText = 'font-weight: bold; color: #666; margin: 0 10px;';
    pageInfo.textContent = `Page ${pagination.currentPage} of ${pagination.totalPages}`;
    paginationDiv.appendChild(pageInfo);

    // Next button
    if (pagination.hasNext) {
        const nextBtn = document.createElement('button');
        nextBtn.className = 'btn btn-secondary';
        nextBtn.innerHTML = 'Next ➡';
        nextBtn.onclick = () => fetchSites(pagination.currentPage + 1, search);
        paginationDiv.appendChild(nextBtn);
    }

    // Page number buttons (show limited set)
    if (pagination.totalPages > 1) {
        const pageButtons = document.createElement('div');
        pageButtons.style.cssText = 'display: flex; gap: 5px; margin-left: 10px; flex-wrap: wrap; justify-content: center;';
        
        const startPage = Math.max(1, pagination.currentPage - 2);
        const endPage = Math.min(pagination.totalPages, pagination.currentPage + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.className = i === pagination.currentPage ? 'btn btn-primary' : 'btn btn-secondary';
            pageBtn.style.padding = '5px 10px';
            pageBtn.style.fontSize = '12px';
            pageBtn.textContent = i;
            pageBtn.onclick = () => fetchSites(i, search);
            pageButtons.appendChild(pageBtn);
        }
        
        paginationDiv.appendChild(pageButtons);
    }

    return paginationDiv;
}

// Helper function to highlight search terms
function highlightText(text, searchTerm) {
    if (!searchTerm) return text;
    
    const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<mark class="search-highlight">$1</mark>');
}
   

async function clearFailedDirectories() {
      const status = document.getElementById('status');

      if (!confirm('Are you sure you want to clear all failed directories? This cannot be undone.')) {
        return;
      }

      status.innerHTML = '🗑️ Clearing failed directories...';

      try {
        const response = await fetch('/failed-directories', {
          method: 'DELETE'
        });

        const result = await response.json();
        status.innerHTML = `✅ ${result.message} (${result.deletedCount} deleted)`;

        // Refresh the failed list (which will now be empty)
        fetchFailedDirectories();
      } catch (error) {
        status.innerHTML = `❌ Error clearing failed directories: ${error.message}`;
      }
    }

    async function fetchSiteSnapshot(siteId, siteName) {
      const status = document.getElementById('status');
      const snapshotData = document.getElementById('snapshotData');
      const changeHistory = document.getElementById('changeHistory');

      status.innerHTML = `📡 Fetching data for ${siteName}...`;
      snapshotData.innerHTML = '';
      changeHistory.innerHTML = '';

      try {
        // Fetch both snapshot and changes in parallel
        const [snapshotResponse, changesResponse] = await Promise.all([
          fetch(`/site/${siteId}/snapshot`),
          fetch(`/site/${siteId}/changes`)
        ]);

        const snapshotResult = await snapshotResponse.json();
        const changesResult = await changesResponse.json();

        // Display the data in console
        console.log('Snapshot Data:', snapshotResult);
        console.log('Changes Data:', changesResult);

        // Display both snapshot and changes
        displaySnapshotData(snapshotResult, siteName);
        displayChangeHistory(changesResult, siteName);

        status.innerHTML = `✅ Data loaded for ${siteName}`;

      } catch (error) {
        status.innerHTML = `❌ Error fetching data: ${error.message}`;
      }
    }

    function displaySnapshotData(result, siteName) {
      const snapshotData = document.getElementById('snapshotData');
      const status = document.getElementById('status');

      if (result.snapshot && result.snapshot.categories) {
        let html = `
                     <div class="snapshot-container">
                    <div style="background-color: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h2>📊 Staff Directory: ${siteName}</h2>
                        <div class="stats">
                            <strong>Snapshot Date:</strong> ${new Date(result.snapshot.snapshotDate).toLocaleString()} | 
                            <strong>Total Staff:</strong> ${result.snapshot.totalCount} | 
                            <strong>Categories:</strong> ${result.snapshot.categories.length}
                        </div>
                    </div>
                `;

        // Process each category
        result.snapshot.categories.forEach(category => {
          html += `
                        <div class="category-section">
                            <div class="category-header">
                                📁 ${category.name} (${category.count} staff)
                            </div>
                    `;

          if (category.members && category.members.length > 0) {
            html += `
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Title</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Fingerprint</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

            category.members.forEach(member => {
              html += `
                                <tr>
                                    <td><strong>${member.name || 'N/A'}</strong></td>
                                    <td>${member.title || 'N/A'}</td>
                                    <td>${member.emails && member.emails.length > 0 ? member.emails.join(', ') : 'N/A'}</td>
                                    <td>${member.phones && member.phones.length > 0 ? member.phones.join(', ') : 'N/A'}</td>
                                    <td style="font-size: 10px; color: #666;">${member.fingerprint || 'N/A'}</td>
                                </tr>
                            `;
            });

            html += `</tbody></table>`;
          } else {
            html += `<div class="no-data">No staff members in this category</div>`;
          }

          html += `</div></div>`; // Close category-section
        });

        snapshotData.innerHTML = html;
        status.innerHTML = `✅ Snapshot data loaded for ${siteName}`;
      } else {
        snapshotData.innerHTML = `<p>No snapshot data available for ${siteName}</p>`;
        status.innerHTML = `ℹ️ No snapshot data found`;
      }
    }

    function displayChangeHistory(result, siteName) {
      const changeHistory = document.getElementById('changeHistory');

      if (result.changes && result.changes.length > 0) {
        let html = `
                    <div class="changes-section">
                        <div class="changes-header">
                            📊 Change History: ${siteName}
                        </div>
                        <div style="margin-bottom: 15px; font-size: 14px;">
                            Showing last ${result.changes.length} changes
                        </div>
                `;

        result.changes.forEach(change => {
          html += `
                        <div class="change-item">
                            <div class="change-meta">
                                <span>🕒 ${new Date(change.date).toLocaleString()}</span>
                                <span>From: ${new Date(change.fromSnapshot).toLocaleDateString()} → To: ${new Date(change.toSnapshot).toLocaleDateString()}</span>
                            </div>
                            
                            <div class="change-stats">
                                <span class="change-stat stat-added">➕ ${change.addedCount} Added</span>
                                <span class="change-stat stat-removed">➖ ${change.removedCount} Removed</span>
                                <span class="change-stat stat-updated">✏️ ${change.updatedCount} Updated</span>
                            </div>
                    `;

          // Show added staff
          if (change.details.added && change.details.added.length > 0) {
            html += `
                            <div class="change-details">
                                <strong>New Staff Added:</strong>
                                <table class="change-table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Title</th>
                                            <th>Category</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
            change.details.added.forEach(staff => {
              html += `
                                <tr>
                                    <td><strong>${staff.name || 'N/A'}</strong></td>
                                    <td>${staff.title || 'N/A'}</td>
                                    <td>${staff.category || 'N/A'}</td>
                                </tr>
                            `;
            });
            html += `</tbody></table>`;
          }

          // Show removed staff
          if (change.details.removed && change.details.removed.length > 0) {
            html += `
                            <div class="change-details">
                                <strong>Staff Removed:</strong>
                                <table class="change-table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Title</th>
                                            <th>Category</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
            change.details.removed.forEach(staff => {
              html += `
                                <tr>
                                    <td><strong>${staff.name || 'N/A'}</strong></td>
                                    <td>${staff.title || 'N/A'}</td>
                                    <td>${staff.category || 'N/A'}</td>
                                </tr>
                            `;
            });
            html += `</tbody></table>`;
          }

          // Show updated staff
          if (change.details.updated && change.details.updated.length > 0) {
            html += `
                            <div class="change-details">
                                <strong>Staff Updated:</strong>
                        `;
            change.details.updated.forEach(update => {
              html += `
                                <table class="change-table" style="margin: 10px 0;">
                                    <thead>
                                        <tr>
                                            <th>Field</th>
                                            <th>Before</th>
                                            <th>After</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
              Object.entries(update.diffs || {}).forEach(([field, diff]) => {
                html += `
                                    <tr>
                                        <td><strong>${field}</strong></td>
                                        <td><span class="diff-highlight">${diff.before || 'N/A'}</span></td>
                                        <td><span class="diff-highlight">${diff.after || 'N/A'}</span></td>
                                    </tr>
                                `;
              });
              html += `</tbody></table>`;
            });
            html += `</div>`;
          }

          html += `</div>`; // Close change-item
        });

        html += `</div>`; // Close changes-section
        changeHistory.innerHTML = html;
      } else {
        changeHistory.innerHTML = `
                    <div class="changes-section">
                        <div class="changes-header">
                            📊 Change History: ${siteName}
                        </div>
                        <p>No changes recorded for this site.</p>
                    </div>
                `;
      }
    }
 
   async function fetchFailedDirectories() {
    const status = document.getElementById('status');
    const failedList = document.getElementById('failedList');
    const sitesList = document.getElementById('sitesList');
    
    status.innerHTML = '📡 Fetching failed directories...';
    failedList.innerHTML = '';
    sitesList.innerHTML = '';
    
    try {
        const response = await fetch('/failed-directories');
        const result = await response.json();
        
        if (result.failedDirectories && result.failedDirectories.length > 0) {
            failedList.innerHTML = `
                <div class="failed-container">
                    <div class="table-header">
                        ❌ Failed Directories (${result.count})
                    </div>
                    <div class="failed-stats">
                        <strong>Total Failed:</strong> ${result.count} | 
                        <strong>Last Updated:</strong> ${new Date().toLocaleString()}
                    </div>
            `;
            
            result.failedDirectories.forEach(failed => {
                const failureBadgeClass = `failure-${failed.failureType.replace('_', '-')}`;
                const failureLabel = failed.failureType === 'no_data' ? 'No Data' : 
                                   failed.failureType === 'fetch_failed' ? 'Fetch Failed' : 
                                   'Parsing Failed';
                
                const failedDiv = document.createElement('div');
                failedDiv.className = 'failed-item';
                failedDiv.innerHTML = `
                    <div>
                        <span class="failure-badge ${failureBadgeClass}">${failureLabel}</span>
                        <strong>${failed.baseUrl}</strong>
                    </div>
                    <div style="margin: 5px 0; font-size: 12px;">
                        <strong>Directory:</strong> <a href='${failed.staffDirectory}' target="_blank">${failed.staffDirectory}</a>
                    </div>
                    <div style="margin: 5px 0; font-size: 12px;">
                        <strong>Attempts:</strong> ${failed.attemptCount} | 
                        <strong>Last Attempt:</strong> ${new Date(failed.lastAttempt).toLocaleString()}
                    </div>
                    <div style="margin: 5px 0; font-size: 12px; color: #d32f2f;">
                        <strong>Error:</strong> ${failed.errorMessage || 'Unknown error'}
                    </div>
                    ${failed.htmlSnippet ? `
                        <div style="margin: 5px 0; font-size: 12px;">
                            <strong>HTML Snippet:</strong>
                            <div class="html-snippet">${failed.htmlSnippet}</div>
                        </div>
                    ` : ''}
                `;
                failedList.appendChild(failedDiv);
            });
            
            failedList.innerHTML += `</div>`; // Close failed-container
            status.innerHTML = `✅ Found ${result.count} failed directories`;
        } else {
            failedList.innerHTML = `
                <div class="failed-container">
                    <div class="table-header">
                        ❌ Failed Directories
                    </div>
                    <p>No failed directories found.</p>
                </div>
            `;
            status.innerHTML = '✅ No failed directories';
        }
    } catch (error) {
        status.innerHTML = `❌ Error fetching failed directories: ${error.message}`;
    }
}
 </script>
</body>

</html>